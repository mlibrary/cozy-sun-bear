<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PdeC No Modals</title>

  <link rel="stylesheet" type="text/css" href="../dist/cozy-sun-bear.css" />
  <script src="../dist/cozy-sun-bear.js"></script>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/headjs/1.0.3/head.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.26.0/polyfill.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/url-search-params/0.10.0/url-search-params.js"></script>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‘¾</text></svg>">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">

  <style>

    *, *::after, *::before {
      box-sizing: border-box;
    }

    body {
      display: grid;
      grid-template-rows: 1fr;
      /* grid-template-columns: min-content minmax(0, min-content) 1fr; */
      grid-template-columns: min-content min-content 1fr;
      grid-gap: 0;

      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
/*
    .nm--toolbar {
      background: #f1f1f1;
      min-height: 0;
      min-width: 0;

      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .nm--reader {
      /* background: #666; /
      min-height: 0;
      min-width: 0;
    }

    .nm--panels {
      background: #f1f1f1;
      min-height: 0;
      min-width: 0;
      display: grid;
      grid-template-columns: 1fr;
      grid-template-rows: 1fr;
      width: 25vw;
    }

    .nm--actions {
      position: fixed;
      bottom: 1rem;
      right: 0;
      background: rgba(0,0,0,0.25);
      padding: 1rem;
      display: flex;
      flex-direction: row;
      gap: 0.5rem;

      z-index: 500;
    }

    .nm--panels[data-modal-actived="false"] {
      width: 0;
    }

    .nm--panels .cozy-modal {
      min-height: 0;
      grid-row: 1/2;
      /* padding: 1rem; /
    }

    .nm--panels .cozy-modal[aria-hidden="true"] {
      clip: rect(1px, 1px, 1px, 1px);
      height: 1px;
      overflow: hidden;
      position: absolute !important;
      width: 1px;
      display: none;;
    }

    .nm--panels .modal__overlay {
        position: static;
    }

    .nm--panels .modal__container {
        width: 100%;
    }

    .nm--panels .modal-slide.left[aria-hidden="false"] .modal__container {
      animation: none;
    }


    .cozy-container {
      width: 100%;
    }

    .nm--panels .modal__container div[role="document"] {
      height: 100%;
    }

    .nm--panels .modal__content {
      height: 88% !important;
    } */

  </style>

</head>
<body>
  
  <div class="nm--toolbar">
    <div id="action-close" class="cozy-control cozy-panel-close">
        <a class="cozy-close cozy-control" href="../examples/" title="Close reader and return to previous page" data-toggle="button" data-slot="label" aria-label="Close reader">
          <i class="icon-x oi" data-glyph="x" aria-hidden="true"></i>
        </a>
    </div>

    <button id="action-contents" data-toggle="open" class="button--sm">
        <i class="icon-align-left oi" data-glyph="align-left" title="Table of Contents" aria-hidden="true"></i>
    </button>

    <button id="action-search" class="button--sm" data-toggle="open" aria-label="Search">
        <i class="icon-magnifying-glass oi" data-glyph="magnifying-glass" title="Search" aria-hidden="true"></i>
    </button>

    <button id="action-notes" class="button--sm notes-panel" data-toggle="open" aria-label="Notes">
        <i class="icon-document oi" data-glyph="document" title="Notes and Definitions" aria-hidden="true"></i>
    </button>

    <div id="action-map" class="cozy-control cozy-panel-map">
        <a class="cozy-control" href="#">
            <i class="icon-map oi" data-glyph="map" aria-hidden="true"></i>
        </a>
    </div>

    <div id="action-resources" class="cozy-control cozy-panel-resources">
        <a class="cozy-control" href="#">
            <i class="icon-folder oi" data-glyph="folder" aria-hidden="true"></i>
        </a>
    </div>

    <button id="action-info" class="button--sm" data-toggle="open" aria-label="Info">
        <i class="icon-info oi" data-glyph="info" title="Book Information" aria-hidden="true"></i>
    </button>

    <div id="action-help" class="cozy-control cozy-panel-feedback">
        <a class="cozy-control" href="https://umich.qualtrics.com/jfe/form/SV_3KSLynPij0fqrD7?publisher=&url=" target="_blank" title="Report a problem or share feedback">
            <i class="icon-question-mark oi" data-glyph="question-mark" aria-hidden="true"></i>
        </a>
    </div>
  </div>

  <div class="nm--panels" data-modal-actived="false"></div>

  <div class="nm--reader" id="reader"></div>

  <!-- <div class="nm--actions" data-active="false">
    <button id="action-preferences" data-toggle="open">
      <i class="bi bi-sliders"></i>
    </button>
  </div> -->

  <script>
    var actions = {}; var panels = {};
    var $panels = document.querySelector('.nm--panels');

    panels.contents = document.querySelector('.panel--contents');
    panels.search = document.querySelector('.panel--search');
    panels.help = document.querySelector('.panel--help');
    panels.notes = document.querySelector('.panel--notes');
    panels.info = document.querySelector('.panel--info');

    actions.contents = document.querySelector('#action-contents');
    actions.search = document.querySelector('#action-search');
    actions.help = document.querySelector('#action-help');
    actions.notes = document.querySelector('#action-notes');
    actions.info = document.querySelector('#action-info');
    //action.contents.setAttribute("data-modal-open", "");

    let fn;
    actions.contents.addEventListener('click', (event) => {
      // panels.contents.setAttribute('aria-hidden',
      //   !(panels.contents.getAttribute('aria-hidden') == 'true'));

      // check to see if button action is open or closed
      if ( actions.contents.hasAttribute("data-modal-open") ) {
        actions.contents.setAttribute("data-modal-close", "");
        actions.contents.removeAttribute("data-modal-open");
      } else {
        actions.contents.setAttribute("data-modal-open", "");
        actions.contents.removeAttribute("data-modal-close");
      }

      if ( actions.contents.hasAttribute("data-modal-close") ) {
          //this.closePanel;
      }

      // check to see if another panel is open
      // if another panel is open, close it and open the selected panel
      
      

      console.log("??", fn);
      if ( fn === undefined ) {
        fn = controls.contents._modal.callbacks.onClose;
        controls.contents._modal.callbacks.onClose = function (modal) {
          console.log("??", fn);
          fn(modal);
          setTimeout(function () {
            console.log("-- should be resizing");
            window.dispatchEvent(new Event('resize'));
          }, 100);
        }
      }
    
      setTimeout(function () {
        window.dispatchEvent(new Event('resize'));
      }, 0);

    })

    actions.search.addEventListener('click', (event) => {
      // panels.search.setAttribute('aria-hidden',
      //   !(panels.search.getAttribute('aria-hidden') == 'true'));

      console.log("??", fn);
      if ( fn === undefined ) {
        fn = controls.contents._modal.callbacks.onClose;
        controls.contents._modal.callbacks.onClose = function (modal) {
          console.log("??", fn);
          fn(modal);
          setTimeout(function () {
            console.log("-- should be resizing");
            window.dispatchEvent(new Event('resize'));
          }, 100);
        }
      }
    
      setTimeout(function () {
        window.dispatchEvent(new Event('resize'));
      }, 0);

    })

  </script>

  <script>
    var reader;
    var controls = {};

    var book_href = '/epub3-local/PdeC/';
    reader = cozy.reader('reader', {
      href: book_href
    });

    cozy.control.navigator({ region: 'bottom.navigator' }).addTo(reader);
    cozy.control.pagePrevious({ region: 'bottom.navigator.right' }).addTo(reader);
    cozy.control.pageNext({ region: 'bottom.navigator.right' }).addTo(reader);
    cozy.control.preferences({ region: 'bottom.navigator.right' }).addTo(reader);
    cozy.control.citation({
                    region: 'bottom.navigator.right',
                    citations: [
                      { format: 'MLA', text: "Mock, Alex. <em>The Mock Life</em>. University Press, 2017." },
                      { format: 'APA', text: "Mock, A. (2017). <em>The Mock Life</em>. Ann Arbor, MI: University Press." },
                      { format: 'Chicago', text: "Mock, Alex. <em>The Mock Life</em>. Ann Arbor, MI: University Press, 2017." }
                    ]
                }).addTo(reader);

    controls.contents = cozy.control.contents({ 
      container: actions.contents,
      modalContainer: $panels,
      closePanel: false
    }).addTo(reader);

    controls.search = cozy.control.search({ 
      container: actions.search,
      modalContainer: $panels,
      closePanel: false
    }).addTo(reader);

    cozy.control.bibliographicInformation({ container: document.querySelector('#action-info')}).addTo(reader);


   // controls.help = 

    //cozy.control.preferences({ container: document.querySelector('#action-preferences') }).addTo(reader);

    // notes panel
    var open_panel = function() {
        var $notes = $("#nm--panels");
        var $book = $(".cozy-module-book-cover");
        close_panel();
        //$("body").addClass("panel-open panel-right");

        var $notesPanel = $('.notes-panel');

        if (! $notesPanel.length) {

            var $notesPanelContent =
                '<div class="notes-panel" aria-hidden="false">' +
                    '<div class="panel-control">' +
                    '</div>' +
                '</div>';
            $notesPanel = $($notesPanelContent).appendTo($notes);
        } else {
            $notesPanel.show();
            $('.notes-panel').prop('hidden', false);
            $('.notes-panel').attr('aria-hidden', 'false');
        }

        // resize EPUB
        setTimeout(function() {
            window.dispatchEvent(new Event('resize'));
        }, 0);

        notes_toggle.state('close-notes');
    } // end open_panel

    // close panel function
    var close_panel = function() {
        var $notesPanel = $('.notes-panel');
        if ($notesPanel.length) {
            $('.notes-panel').hide();
            //$('body').removeClass('panel-open');
            //$('body').removeClass('panel-right');
            $('.notes-panel').prop('hidden', true);
            $('.notes-panel').attr('aria-hidden', 'true');
            
            setTimeout(function() {
                window.dispatchEvent(new Event('resize'));
            }, 0);
        }
        notes_toggle.state('open-notes');
    }


    // text tools
    var tools_panel = function() {
        var $main = $(".cozy-module-bottom");

        var $text_tools = $('.cozy-text-tools');

        var $textPanelContent = 
        '<div class="cozy-text-tools">' +
            '<div class="versions">' +
                '<fieldset>' +
                    '<div>Version display</div>' +
                    '<div class="checkbox checkbox--svg"><input class="sr-only" type="checkbox" id="french" name="french" checked>' +
                        '<label class="svg" for="french">' +
                            '<svg viewBox="0 0 100 100"><path class="path" fill="none" stroke="#000" stroke-width="13" d="M12.1 52.1l24.4 24.4 53-53"/></svg>' +
                            'FranÃ§aise</label></div>' +
                    '<div class="checkbox checkbox--svg"><input class="sr-only" type="checkbox" id="english" name="english" checked>' +
                        '<label class="svg" for="english">' +
                            '<svg viewBox="0 0 100 100"><path class="path" fill="none" stroke="#000" stroke-width="13" d="M12.1 52.1l24.4 24.4 53-53"/></svg>' +
                            'English</label></div>' +
                '</fieldset>' +
            '</div>' +
            '<div class="tools">' +
                '<fieldset>' +
                    '<div>Text Tools</div>' +
                    '<div class="checkbox checkbox--svg"><input class="sr-only" type="checkbox" id="passages" name="passages">' +
                        '<label class="svg" for="passages">' +
                            '<svg viewBox="0 0 100 100"><path class="path" fill="none" stroke="#000" stroke-width="13" d="M12.1 52.1l24.4 24.4 53-53"/></svg>' +
                            'Show key passages</label></div>' +
                    '<div class="checkbox checkbox--svg"><input class="sr-only" type="checkbox" id="terms" name="terms">' +
                        '<label class="svg" for="terms">' +
                            '<svg viewBox="0 0 100 100"><path class="path" fill="none" stroke="#000" stroke-width="13" d="M12.1 52.1l24.4 24.4 53-53"/></svg>' +
                            'Show frequently used terms</label></div>' +
                    '<div class="checkbox checkbox--svg"><input class="sr-only" type="checkbox" id="definitions" name="definitions">' +
                        '<label class="svg" for="definitions">' +
                            '<svg viewBox="0 0 100 100"><path class="path" fill="none" stroke="#000" stroke-width="13" d="M12.1 52.1l24.4 24.4 53-53"/></svg>' +
                            'Show words with definitions</label></div>' +
                '</fieldset>' +
            '</div>' +
        '</div>';

        $text_tools = $($textPanelContent).prependTo($main);
    }

    reader.on('ready:contents', function(contents) {
        const frenchCheckbox = document.querySelector('#french');
        const frenchText =  contents.document.querySelector("body.french");
        const englishCheckbox = document.querySelector('#english');
        const englishText =  contents.document.querySelector("body.english");
        
        const passageCheckbox = document.querySelector('#passages');

        const termsCheckbox = document.querySelector('#terms');
        var terms = contents.content.querySelectorAll(".FrequentlyUsedTerm", ".FrequentlyUsedTermTermwDefinition");
        termsCheckbox.addEventListener('change', (contents) => {
            if (termsCheckbox.checked) {
                if (terms !== null) {
                    for(var i =0, n = terms.length; i < n; i++) {
                        var term = terms[i];
                        term.classList.add('highlight');
                    }
                }
            } else {
                if (terms !== null) {
                    for(var i =0, n = terms.length; i < n; i++) {
                        var term = terms[i];
                        term.classList.remove('highlight');
                    }
                }
            }

        });

        const definitionCheckbox = document.querySelector('#definitions');
        var definitions = contents.content.querySelectorAll("[data-note-type='definition']");
        definitionCheckbox.addEventListener('change', (contents) => {
            if (definitionCheckbox.checked) {
                if (definitions !== null) {
                    for(var i =0, n = definitions.length; i < n; i++) {
                        var definition = definitions[i];
                        definition.classList.add('highlight');
                    }
                }
            } else {
                if (definitions !== null) {
                    for(var i =0, n = definitions.length; i < n; i++) {
                        var definition = definitions[i];
                        definition.classList.remove('highlight');
                    }
                }
            }

        });

        frenchCheckbox.addEventListener('change', (contents) => {
            if (frenchCheckbox.checked) {
                if (frenchText !== null) {
                    frenchText.classList.remove('hide');
                    frenchText.classList.add('display');
                }
            } else {
                if (frenchText !== null) {
                    frenchText.classList.remove('display');
                    frenchText.classList.add('hide');
                }
            }
        });

        englishCheckbox.addEventListener('change', (contents) => {
            if (englishCheckbox.checked) {
                if (englishText !== null) {
                    englishText.classList.remove('hide');
                    englishText.classList.add('display');
                }
            } else {
                if (englishText !== null) {
                    englishText.classList.remove('display');
                    englishText.classList.add('hide');
                }
            }
        });

    });

    // notes
        // function for opening panel like gabii open_panel()
        // functions for getting content and building out panel
            // displayed with headings and accordians
            // definitions
                // build list
                // display content
            // translator notes
                // build list
                // display content
            // historical characters
                // build list
                // display content
        // event listeners for links in epub
        // function for opening notes panel when a notes link is clicked
            //var epubClickHandler = function(event) {
            //    if (event.target.hasAttribute('data-tid')) {
            //        var s = event.target.getAttribute('data-tid');
            //    } else {
            //    var s = event.target.getAttribute('data-uid');
            //    }
            // send note href data to panel
            // open panel and display matching note
            //}
        // get all the links for the notes and listen for clicks 
        // reader.on('ready:contents', function(contents) {
        // var links = contents.content.querySelectorAll(" ## list of attribute selectors ##");
        // for(var i=0, n= = links.length; i < n; i++){
        // var link = links[i];
        // link.addEventListener('click', epubClickHandler);
        //}
        //})


    reader.start(function () {
      console.log('-- started');
      tools_panel();
    });

    reader.on('resized', function () {
      console.log(":: resize detected");
    })


  </script>

</body>
</html>